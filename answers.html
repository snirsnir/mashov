<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תוצאות המשוב - סדנת מנהלים</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #1a2d4f;
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #1a2d4f;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #2a5298;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-container h2 {
            color: #1a2d4f;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            border-right: 4px solid #2a5298;
            padding-right: 15px;
        }

        .chart-container .question-subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            padding-right: 19px;
            line-height: 1.5;
        }

        .text-responses {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .text-responses h2 {
            color: #1a2d4f;
            margin-bottom: 20px;
            font-size: 22px;
            border-right: 4px solid #2a5298;
            padding-right: 15px;
        }

        .response-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-right: 3px solid #2a5298;
        }

        .response-item .timestamp {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .response-item .content {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 24px;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 12px;
            color: #666;
            font-size: 18px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(42, 82, 152, 0.4);
            transition: all 0.3s;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(42, 82, 152, 0.5);
        }

        .export-btn {
            background: #4caf50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .header p {
                font-size: 14px;
            }

            .refresh-btn {
                padding: 12px 30px;
                font-size: 15px;
                margin: 15px auto;
            }

            .export-btn {
                padding: 10px 25px;
                font-size: 13px;
                margin: 8px;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 18px 15px;
            }

            .stat-card h3 {
                font-size: 15px;
                margin-bottom: 12px;
            }

            .stat-number {
                font-size: 36px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart-container {
                padding: 20px 15px;
            }

            .chart-container h2 {
                font-size: 16px;
                padding-right: 12px;
            }

            .chart-container .question-subtitle {
                font-size: 13px;
                padding-right: 16px;
                margin-bottom: 15px;
            }

            .text-responses {
                padding: 20px 15px;
            }

            .text-responses h2 {
                font-size: 18px;
                padding-right: 12px;
            }

            .response-item {
                padding: 12px;
            }

            .response-item .timestamp {
                font-size: 11px;
            }

            .response-item .content {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 13px;
            }

            .stats-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 15px 12px;
            }

            .stat-card h3 {
                font-size: 14px;
            }

            .stat-number {
                font-size: 32px;
            }

            .chart-container h2 {
                font-size: 15px;
            }

            .chart-container .question-subtitle {
                font-size: 12px;
            }

            .refresh-btn {
                width: 100%;
                padding: 14px 20px;
            }

            .export-btn {
                width: calc(100% - 20px);
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>תוצאות שאלון משוב - סדנת מנהלים</h1>
            <p>ניתוח ויזואלי של התגובות שהתקבלו</p>
            <button class="refresh-btn" onclick="location.reload()">רענן נתונים</button>
            <button class="export-btn" onclick="exportToCSV()">ייצא ל-CSV</button>
        </div>

        <div id="loading" class="loading">טוען נתונים...</div>
        <div id="content" style="display: none;">
            <div class="stats-container">
                <div class="stat-card">
                    <h3>סך כל התגובות</h3>
                    <div class="stat-number" id="totalResponses">0</div>
                </div>
                <div class="stat-card">
                    <h3>ממוצע משמעותיות הסדנא</h3>
                    <div class="stat-number" id="avgWorkshop">0</div>
                </div>
                <div class="stat-card">
                    <h3>מנהלים בדחיינות</h3>
                    <div class="stat-number" id="procrastinationYes">0%</div>
                </div>
                <div class="stat-card">
                    <h3>מנהלים בהתקרבנות</h3>
                    <div class="stat-number" id="victimYes">0%</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h2>שאלה 1</h2>
                    <div class="question-subtitle">הרגשתי כי הסדנא הראשונה הייתה משמעותית עבורי</div>
                    <canvas id="q1Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 2</h2>
                    <div class="question-subtitle">האם ישנם מנהלים בטכנודע שנוהגים בדחיינות, אינם ממהרים לבצע משימות או נוטים לדחות ביצוע?</div>
                    <canvas id="q2Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 3</h2>
                    <div class="question-subtitle">כמה מנהלים בדחיינות אתה מזהה בטכנודע?</div>
                    <canvas id="q3Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 4</h2>
                    <div class="question-subtitle">האם שוחחת עם אותם מנהלים בעבר לגבי התנהגות הדחיינות?</div>
                    <canvas id="q4Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 6</h2>
                    <div class="question-subtitle">האם ישנם מנהלים שנוטים "להתקרבן" - להסביר אי־ביצוע בתירוצים, האשמת גורמים אחרים או עומס קבוע?</div>
                    <canvas id="q6Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 9</h2>
                    <div class="question-subtitle">האם אתה מכיר מנהלים שנוטים להגיב בשלילה מיידית לבקשות ("אי אפשר", "אין לי זמן", "זה לא יקרה")?</div>
                    <canvas id="q9Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 12</h2>
                    <div class="question-subtitle">עד כמה התנהגויות הדחיינות/התקרבנות/שלילה משפיעות על עבודתך או על עבודת הצוותים בארגון?</div>
                    <canvas id="q12Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 13</h2>
                    <div class="question-subtitle">מה לדעתך שורש ההתנהגות (דחיינות / התקרבנות / תגובה שלילית)? (בחירה מרובה)</div>
                    <canvas id="q13Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 14</h2>
                    <div class="question-subtitle">האם אתה מזהה מנהלים שחסרה אצלם פרואקטיביות (יוזמה, פתרון בעיות, ראיית מעגל ההשפעה)?</div>
                    <canvas id="q14Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 15</h2>
                    <div class="question-subtitle">האם פנית לאותם מנהלים בנושא זה?</div>
                    <canvas id="q15Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 17</h2>
                    <div class="question-subtitle">כשאתה מזהה פער התנהגותי אצל קולגה - מהי התגובה הטבעית שלך?</div>
                    <canvas id="q17Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 18</h2>
                    <div class="question-subtitle">האם אתה מרגיש שיש בטכנודע לגיטימציה לקיים "שיחות אמיצות" בין מנהלים?</div>
                    <canvas id="q18Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 19</h2>
                    <div class="question-subtitle">עד כמה אתה מרגיש שיש כנות ופתיחות בין חברי ההנהלה בנוגע להתנהגויות בעייתיות?</div>
                    <canvas id="q19Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 20</h2>
                    <div class="question-subtitle">עד כמה אתה מרגיש שהמנהלים שעליהם דיווחת מודעים לפער ההתנהגותי שאתה מתאר?</div>
                    <canvas id="q20Chart"></canvas>
                </div>

                <div class="chart-container">
                    <h2>שאלה 21</h2>
                    <div class="question-subtitle">האם ההתנהגויות שתיארת הן נקודתיות או עקביות לאורך זמן?</div>
                    <canvas id="q21Chart"></canvas>
                </div>
            </div>

            <div class="text-responses">
                <h2>שאלה 16: שמות או דוגמאות ספציפיות (פרואקטיביות)</h2>
                <div id="q16Responses"></div>
            </div>

            <div class="text-responses">
                <h2>שאלה 22: כיצד ההנהלה כקבוצה יכולה לטפל בתופעה?</h2>
                <div id="q22Responses"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ82MgwWCmMaEQQbyCKc_O2sA4i3tJ8ZI",
            authDomain: "forme-a3c26.firebaseapp.com",
            databaseURL: "https://forme-a3c26-default-rtdb.firebaseio.com",
            projectId: "forme-a3c26",
            storageBucket: "forme-a3c26.firebasestorage.app",
            messagingSenderId: "1026375487564",
            appId: "1:1026375487564:web:6a275bacad937a283ba4e9"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let allResponses = [];

        // Color schemes - positive = green, negative = red, neutral = blue
        const colorSchemes = {
            positive: ['#4caf50', '#66bb6a', '#81c784', '#a5d6a7', '#c8e6c9', '#e8f5e9'],
            negative: ['#ef5350', '#e57373', '#ef9a9a', '#ffcdd2', '#ffebee', '#f44336'],
            neutral: ['#2a5298', '#4a7bc8', '#6b9bd8', '#8bb3e8', '#abc4f0', '#1e3c72'],
            mixed: ['#4caf50', '#ef5350', '#2a5298', '#ff9800', '#9c27b0', '#00bcd4']
        };

        onValue(ref(database, 'survey_responses'), (snapshot) => {
            const data = snapshot.val();

            if (!data) {
                document.getElementById('loading').innerHTML = '<div class="no-data">אין תגובות עדיין</div>';
                return;
            }

            allResponses = Object.values(data);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            renderStats();
            renderCharts();
            renderTextResponses();
        });

        function renderStats() {
            const total = allResponses.length;
            document.getElementById('totalResponses').textContent = total;

            const q1Values = allResponses.map(r => parseInt(r.q1)).filter(v => !isNaN(v));
            const avgWorkshop = q1Values.length > 0 ?
                (q1Values.reduce((a, b) => a + b, 0) / q1Values.length).toFixed(1) : 0;
            document.getElementById('avgWorkshop').textContent = avgWorkshop;

            const procrastinationYes = allResponses.filter(r => r.q2 === 'כן').length;
            const procrastinationPct = total > 0 ? ((procrastinationYes / total) * 100).toFixed(0) : 0;
            document.getElementById('procrastinationYes').textContent = procrastinationPct + '%';

            const victimYes = allResponses.filter(r => r.q6 === 'כן').length;
            const victimPct = total > 0 ? ((victimYes / total) * 100).toFixed(0) : 0;
            document.getElementById('victimYes').textContent = victimPct + '%';
        }

        function countValues(responses, field) {
            const counts = {};
            responses.forEach(r => {
                const value = r[field];
                if (value && value !== 'לא רלוונטי') {
                    if (Array.isArray(value)) {
                        value.forEach(v => {
                            counts[v] = (counts[v] || 0) + 1;
                        });
                    } else {
                        counts[value] = (counts[value] || 0) + 1;
                    }
                }
            });
            return counts;
        }

        // פונקציה להמרת ערכי שאלה 1 לתיאורים
        function convertQ1Labels(counts) {
            const labelMap = {
                '1': '1 - כלל לא',
                '2': '2 - במידה מועטה',
                '3': '3 - במידה בינונית',
                '4': '4 - במידה רבה',
                '5': '5 - במידה רבה מאוד'
            };

            // צור אובייקט חדש בסדר הנכון (1,2,3,4,5)
            const newCounts = {};
            ['1', '2', '3', '4', '5'].forEach(key => {
                if (counts[key]) {
                    const newKey = labelMap[key];
                    newCounts[newKey] = counts[key];
                }
            });
            return newCounts;
        }

        function getColorsForQuestion(questionNum, labels) {
            // Q1 - higher is better (positive)
            if (questionNum === 1) {
                return labels.map(l => {
                    // חלץ את המספר מהתיאור (למשל "4 - במידה רבה" -> 4)
                    const val = parseInt(l.split(' ')[0]) || parseInt(l);
                    if (val >= 4) return colorSchemes.positive[0];
                    if (val === 3) return colorSchemes.neutral[0];
                    return colorSchemes.negative[0];
                });
            }

            // Q2, Q6, Q9, Q12 - כן/לא (כן = negative, לא = positive)
            if ([2, 6, 9, 12].includes(questionNum)) {
                return labels.map(l => l === 'כן' ? colorSchemes.negative[0] : colorSchemes.positive[0]);
            }

            // Q4 - communication attempts
            if (questionNum === 4) {
                const colorMap = {
                    'כן, שוחחתי בצורה ישירה': colorSchemes.positive[0],
                    'כן, העליתי זאת בשיחה עקיפה': colorSchemes.positive[2],
                    'לא, נמנעתי מלפנות': colorSchemes.negative[0],
                    'לא, זה לא תפקידי בעיניי': colorSchemes.negative[1]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q12 - impact on work (negative impact = red)
            if (questionNum === 12) {
                const colorMap = {
                    'משפיעות מאוד לרעה': colorSchemes.negative[0],
                    'משפיעות במידה בינונית': colorSchemes.negative[2],
                    'משפיעות מעט': colorSchemes.neutral[2],
                    'אינן משפיעות': colorSchemes.positive[0],
                    'איני יודע': colorSchemes.neutral[4]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q14 - proactivity (כן/לא)
            if (questionNum === 14) {
                return labels.map(l => l === 'כן' ? colorSchemes.negative[0] : colorSchemes.positive[0]);
            }

            // Q15 - willingness to approach colleagues
            if (questionNum === 15) {
                const colorMap = {
                    'כן': colorSchemes.positive[0],
                    'תלוי בסיטואציה': colorSchemes.neutral[0],
                    'לא': colorSchemes.negative[0]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q17 - natural response
            if (questionNum === 17) {
                const colorMap = {
                    'אני פונה אליו בשיחה ישירה': colorSchemes.positive[0],
                    'אני מתייעץ עם מנהל אחר': colorSchemes.positive[2],
                    'אני נותן לדברים "להסתדר מעצמם"': colorSchemes.negative[1],
                    'אני נמנע בגלל חשש לעימות': colorSchemes.negative[0]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q18 - legitimacy for brave conversations
            if (questionNum === 18) {
                const colorMap = {
                    'כן, מאוד': colorSchemes.positive[0],
                    'כן, מעט': colorSchemes.positive[2],
                    'לא מספיק': colorSchemes.negative[2],
                    'בכלל לא': colorSchemes.negative[0]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q19 - honesty and openness
            if (questionNum === 19) {
                const colorMap = {
                    'גבוהה מאוד': colorSchemes.positive[0],
                    'גבוהה': colorSchemes.positive[1],
                    'בינונית': colorSchemes.neutral[0],
                    'נמוכה': colorSchemes.negative[2],
                    'נמוכה מאוד': colorSchemes.negative[0]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q20 - awareness of behavioral gap
            if (questionNum === 20) {
                const colorMap = {
                    'מודעים מאוד': colorSchemes.positive[0],
                    'מודעים חלקית': colorSchemes.neutral[0],
                    'לא מודעים': colorSchemes.negative[2],
                    'מתנגדים למשוב': colorSchemes.negative[0],
                    'איני יודע': colorSchemes.neutral[4]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Q21 - consistency
            if (questionNum === 21) {
                const colorMap = {
                    'עקביות מאוד': colorSchemes.negative[0],
                    'חוזרות מדי פעם': colorSchemes.negative[2],
                    'מקרים בודדים': colorSchemes.positive[2],
                    'לא בטוח': colorSchemes.neutral[0]
                };
                return labels.map(l => colorMap[l] || colorSchemes.neutral[0]);
            }

            // Default - use varied colors
            return colorSchemes.mixed;
        }

        function createChart(canvasId, questionNum, label, counts, type = 'bar') {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(counts);
            const data = Object.values(counts);

            // תמיד קבל צבעים לפי מספר השאלה - גם לעמודות וגם ל-doughnut
            const colors = getColorsForQuestion(questionNum, labels);

            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors,
                        borderColor: type === 'bar' ? '#1e3c72' : 'white',
                        borderWidth: type === 'bar' ? 1 : 2,
                        barThickness: type === 'bar' ? 40 : undefined,  // עובי עמודה מוגבל
                        maxBarThickness: type === 'bar' ? 50 : undefined  // מקסימום עובי
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: type === 'pie' || type === 'doughnut',
                            position: 'bottom',
                            rtl: true,
                            labels: {
                                font: {
                                    size: 13,
                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                },
                                padding: 15
                            }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                }
            });
        }

        function renderCharts() {
            const q1Counts = convertQ1Labels(countValues(allResponses, 'q1'));
            createChart('q1Chart', 1, 'תגובות', q1Counts, 'bar');

            const q2Counts = countValues(allResponses, 'q2');
            createChart('q2Chart', 2, 'תגובות', q2Counts, 'doughnut');

            const q3Counts = countValues(allResponses, 'q3');
            createChart('q3Chart', 3, 'תגובות', q3Counts, 'bar');

            const q4Counts = countValues(allResponses, 'q4');
            createChart('q4Chart', 4, 'תגובות', q4Counts, 'bar');

            const q6Counts = countValues(allResponses, 'q6');
            createChart('q6Chart', 6, 'תגובות', q6Counts, 'doughnut');

            const q9Counts = countValues(allResponses, 'q9');
            createChart('q9Chart', 9, 'תגובות', q9Counts, 'doughnut');

            const q12Counts = countValues(allResponses, 'q12');
            createChart('q12Chart', 12, 'תגובות', q12Counts, 'bar');

            const q13Counts = countValues(allResponses, 'q13');
            createChart('q13Chart', 13, 'תגובות', q13Counts, 'bar');

            const q14Counts = countValues(allResponses, 'q14');
            createChart('q14Chart', 14, 'תגובות', q14Counts, 'doughnut');

            const q15Counts = countValues(allResponses, 'q15');
            createChart('q15Chart', 15, 'תגובות', q15Counts, 'doughnut');

            const q17Counts = countValues(allResponses, 'q17');
            createChart('q17Chart', 17, 'תגובות', q17Counts, 'bar');

            const q18Counts = countValues(allResponses, 'q18');
            createChart('q18Chart', 18, 'תגובות', q18Counts, 'bar');

            const q19Counts = countValues(allResponses, 'q19');
            createChart('q19Chart', 19, 'תגובות', q19Counts, 'bar');

            const q20Counts = countValues(allResponses, 'q20');
            createChart('q20Chart', 20, 'תגובות', q20Counts, 'bar');

            const q21Counts = countValues(allResponses, 'q21');
            createChart('q21Chart', 21, 'תגובות', q21Counts, 'bar');
        }

        function renderTextResponses() {
            const q16Container = document.getElementById('q16Responses');
            const q16Responses = allResponses.filter(r => r.q16 && r.q16.trim() !== '');

            if (q16Responses.length === 0) {
                q16Container.innerHTML = '<div class="no-data">אין תגובות טקסט</div>';
            } else {
                q16Container.innerHTML = q16Responses.map(r => `
                    <div class="response-item">
                        <div class="timestamp">${new Date(r.timestamp).toLocaleString('he-IL')}</div>
                        <div class="content">${r.q16}</div>
                    </div>
                `).join('');
            }

            const q22Container = document.getElementById('q22Responses');
            const q22Responses = allResponses.filter(r => r.q22 && r.q22.trim() !== '');

            if (q22Responses.length === 0) {
                q22Container.innerHTML = '<div class="no-data">אין תגובות טקסט</div>';
            } else {
                q22Container.innerHTML = q22Responses.map(r => `
                    <div class="response-item">
                        <div class="timestamp">${new Date(r.timestamp).toLocaleString('he-IL')}</div>
                        <div class="content">${r.q22}</div>
                    </div>
                `).join('');
            }
        }

        window.exportToCSV = function() {
            if (allResponses.length === 0) {
                alert('אין נתונים לייצוא');
                return;
            }

            const headers = [
                'תאריך ושעה',
                'שאלה 1 - משמעותיות הסדנא',
                'שאלה 2 - מנהלים בדחיינות',
                'שאלה 3 - כמה מנהלים בדחיינות',
                'שאלה 4 - שוחחת עם מנהלים',
                'שאלה 5 - סיבה לאי שיחה',
                'שאלה 6 - מנהלים בהתקרבנות',
                'שאלה 7 - כמה מנהלים בהתקרבנות',
                'שאלה 8 - שוחחת עם מנהלים מתקרבנים',
                'שאלה 9 - תגובתיות שלילית',
                'שאלה 10 - כמה מנהלים בתגובתיות שלילית',
                'שאלה 11 - התייחסת לתגובתיות',
                'שאלה 12 - השפעה על העבודה',
                'שאלה 13 - שורש ההתנהגות',
                'שאלה 14 - חוסר פרואקטיביות',
                'שאלה 15 - מקובל לפנות לקולגות (פרואקטיביות)',
                'שאלה 16 - שמות ודוגמאות (פרואקטיביות)',
                'שאלה 17 - תגובה טבעית לפער',
                'שאלה 18 - לגיטימציה לשיחות אמיצות',
                'שאלה 19 - כנות ופתיחות',
                'שאלה 20 - מודעות לפער',
                'שאלה 21 - עקביות ההתנהגויות',
                'שאלה 22 - כיצד לטפל בתופעה'
            ];

            const csvRows = [headers.join(',')];

            allResponses.forEach(r => {
                const row = [
                    new Date(r.timestamp).toLocaleString('he-IL'),
                    r.q1,
                    r.q2,
                    r.q3,
                    r.q4,
                    r.q5,
                    r.q6,
                    r.q7,
                    r.q8,
                    r.q9,
                    r.q10,
                    r.q11,
                    r.q12,
                    Array.isArray(r.q13) ? `"${r.q13.join(', ')}"` : r.q13,
                    r.q14,
                    r.q15,
                    `"${(r.q16 || '').replace(/"/g, '""')}"`,
                    r.q17,
                    r.q18,
                    r.q19,
                    r.q20,
                    r.q21,
                    `"${(r.q22 || '').replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = '\ufeff' + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `survey_results_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };
    </script>
</body>
</html>
